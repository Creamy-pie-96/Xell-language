<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ScriptIt Notebook</title>
<style>
/* â”€â”€â”€ CSS Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
    --bg-primary: #0d1117;
    --bg-secondary: #161b22;
    --bg-cell: #1c2128;
    --bg-cell-active: #21262d;
    --bg-cell-running: #1a2332;
    --bg-editor: #0d1117;
    --bg-output: #161b22;
    --bg-hover: #30363d;
    --border: #30363d;
    --border-active: #58a6ff;
    --border-success: #3fb950;
    --border-error: #f85149;
    --text-primary: #e6edf3;
    --text-secondary: #8b949e;
    --text-dim: #484f58;
    --accent: #58a6ff;
    --accent-hover: #79c0ff;
    --success: #3fb950;
    --error: #f85149;
    --warning: #d29922;
    --stdout-color: #e6edf3;
    --stderr-color: #f85149;
    --result-color: #58a6ff;
    --font-mono: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', 'SF Mono', 'Consolas', monospace;
    --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
    --cell-radius: 8px;
    --toolbar-height: 52px;
    --transition: 150ms ease;
}

body {
    font-family: var(--font-sans);
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.5;
    overflow-x: hidden;
}

/* â”€â”€â”€ Toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toolbar {
    position: fixed;
    top: 0; left: 0; right: 0;
    height: var(--toolbar-height);
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 16px;
    z-index: 100;
    gap: 6px;
}

.toolbar-brand {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-right: 12px;
    user-select: none;
}

.toolbar-brand .logo {
    font-size: 17px;
    font-weight: 700;
    color: var(--accent);
    letter-spacing: -0.5px;
}

.toolbar-brand .logo span {
    color: var(--text-secondary);
    font-weight: 400;
}

.toolbar-title {
    background: transparent;
    border: 1px solid transparent;
    color: var(--text-primary);
    font-size: 14px;
    font-family: var(--font-sans);
    padding: 4px 8px;
    border-radius: 4px;
    outline: none;
    min-width: 100px;
    max-width: 260px;
    transition: border-color var(--transition);
}

.toolbar-title:hover { border-color: var(--border); }
.toolbar-title:focus { border-color: var(--accent); }

.toolbar-sep {
    width: 1px; height: 24px;
    background: var(--border);
    margin: 0 4px;
}

.toolbar-btn {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 5px 10px;
    border: none;
    border-radius: 6px;
    background: transparent;
    color: var(--text-secondary);
    font-size: 12px;
    font-family: var(--font-sans);
    cursor: pointer;
    transition: all var(--transition);
    white-space: nowrap;
}

.toolbar-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
.toolbar-btn.primary { background: var(--accent); color: #fff; }
.toolbar-btn.primary:hover { background: var(--accent-hover); }
.toolbar-btn svg { width: 15px; height: 15px; fill: currentColor; }

.toolbar-spacer { flex: 1; }

.kernel-status {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: var(--text-secondary);
}

.kernel-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--success);
    transition: background var(--transition);
}

.kernel-dot.dead { background: var(--error); }
.kernel-dot.busy { background: var(--warning); animation: pulse 1s infinite; }

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
}

/* â”€â”€â”€ Main Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.content {
    margin-top: var(--toolbar-height);
    padding: 24px;
    max-width: 960px;
    margin-left: auto;
    margin-right: auto;
    padding-bottom: 80px;
}

/* â”€â”€â”€ Cell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cell {
    position: relative;
    margin-bottom: 2px;
    border-radius: var(--cell-radius);
    border: 1px solid transparent;
    transition: all var(--transition);
    background: var(--bg-cell);
}

.cell:hover { border-color: var(--border); }
.cell.active { border-color: var(--border-active); background: var(--bg-cell-active); }
.cell.running { border-color: var(--warning); background: var(--bg-cell-running); }
.cell.error-state { border-color: var(--border-error); }

/* Cell gutter */
.cell-gutter {
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 52px;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-top: 10px;
    gap: 4px;
    user-select: none;
}

.cell-exec-count {
    font-size: 11px;
    font-family: var(--font-mono);
    color: var(--text-dim);
    min-width: 32px;
    text-align: center;
    line-height: 1;
}

.cell-exec-count.has-count { color: var(--text-secondary); }

.cell-run-btn {
    width: 28px; height: 28px;
    border: none;
    border-radius: 6px;
    background: transparent;
    color: var(--text-dim);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition);
    opacity: 0;
}

.cell:hover .cell-run-btn, .cell.active .cell-run-btn { opacity: 1; }
.cell-run-btn:hover { background: var(--accent); color: white; }
.cell-run-btn svg { width: 14px; height: 14px; fill: currentColor; }

/* Spinning animation for run button while cell is running */
.cell.running .cell-run-btn { opacity: 1; color: var(--warning); pointer-events: none; }
.cell.running .cell-run-btn svg {
    animation: spinRun 0.8s linear infinite;
    transform-origin: center;
}
@keyframes spinRun {
    from { transform: rotate(0deg); }
    to   { transform: rotate(360deg); }
}

/* Markdown edit button */
.markdown-edit-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 28px; height: 28px;
    border: none;
    border-radius: 6px;
    background: var(--bg-secondary);
    color: var(--text-dim);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition);
    font-size: 14px;
    opacity: 0;
    z-index: 2;
}
.cell:hover .markdown-edit-btn { opacity: 1; }
.markdown-edit-btn:hover { background: var(--accent); color: white; }

/* Cell body */
.cell-body { margin-left: 52px; }

/* Code editor */
.cell-editor {
    position: relative;
    background: var(--bg-editor);
    border-radius: 4px 4px 0 0;
    overflow: hidden;
}

.cell-textarea {
    width: 100%;
    min-height: 42px;
    padding: 12px 16px;
    background: transparent;
    border: none;
    color: var(--text-primary);
    font-family: var(--font-mono);
    font-size: 14px;
    line-height: 1.6;
    resize: none;
    outline: none;
    tab-size: 4;
    overflow: hidden;
    display: block;
}

.cell-textarea::placeholder { color: var(--text-dim); }
.cell-textarea::-webkit-scrollbar { display: none; }

/* Markdown cell */
.markdown-rendered {
    padding: 12px 16px;
    color: var(--text-primary);
    line-height: 1.7;
    cursor: pointer;
    min-height: 30px;
}

.markdown-rendered h1 { font-size: 1.8em; font-weight: 600; margin: 0.5em 0 0.3em; border-bottom: 1px solid var(--border); padding-bottom: 0.3em; }
.markdown-rendered h2 { font-size: 1.4em; font-weight: 600; margin: 0.5em 0 0.3em; border-bottom: 1px solid var(--border); padding-bottom: 0.3em; }
.markdown-rendered h3 { font-size: 1.2em; font-weight: 600; margin: 0.5em 0 0.2em; }
.markdown-rendered p { margin: 0.4em 0; }
.markdown-rendered code { background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: var(--font-mono); font-size: 0.9em; }
.markdown-rendered pre { background: var(--bg-editor); padding: 12px 16px; border-radius: 6px; overflow-x: auto; margin: 0.5em 0; }
.markdown-rendered pre code { background: none; padding: 0; }
.markdown-rendered strong { font-weight: 600; }
.markdown-rendered em { font-style: italic; }
.markdown-rendered ul, .markdown-rendered ol { margin: 0.4em 0; padding-left: 2em; }
.markdown-rendered li { margin: 0.2em 0; }
.markdown-rendered blockquote { border-left: 3px solid var(--accent); padding-left: 12px; color: var(--text-secondary); margin: 0.5em 0; }
.markdown-rendered hr { border: none; border-top: 1px solid var(--border); margin: 1em 0; }
.markdown-rendered a { color: var(--accent); text-decoration: none; }
.markdown-rendered a:hover { text-decoration: underline; }

/* Cell output */
.cell-output {
    border-top: 1px solid var(--border);
    background: var(--bg-output);
    border-radius: 0 0 4px 4px;
    max-height: 400px;
    overflow-y: auto;
}

.cell-output:empty { display: none; }

.cell-output pre {
    padding: 10px 16px;
    margin: 0;
    font-family: var(--font-mono);
    font-size: 13px;
    line-height: 1.5;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.output-stdout { color: var(--stdout-color); }
.output-stderr { color: var(--stderr-color); }
.output-result { color: var(--result-color); }

.cell-output::-webkit-scrollbar { width: 6px; }
.cell-output::-webkit-scrollbar-track { background: transparent; }
.cell-output::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* Cell actions (hover menu) */
.cell-actions {
    position: absolute;
    right: 8px;
    top: 8px;
    display: flex;
    gap: 2px;
    opacity: 0;
    transition: opacity var(--transition);
}

.cell:hover .cell-actions, .cell.active .cell-actions { opacity: 1; }

.cell-action-btn {
    width: 26px; height: 26px;
    border: none;
    border-radius: 4px;
    background: var(--bg-secondary);
    color: var(--text-dim);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition);
    font-size: 13px;
}

.cell-action-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
.cell-action-btn.delete:hover { color: var(--error); }

.cell-action-btn svg { width: 14px; height: 14px; fill: currentColor; }

/* Add-cell divider between cells */
.add-cell-divider {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 24px;
    position: relative;
    opacity: 0;
    transition: opacity var(--transition);
}

.add-cell-divider:hover,
.add-cell-divider.visible {
    opacity: 1;
}

.add-cell-divider .divider-line {
    position: absolute;
    left: 52px; right: 0;
    height: 1px;
    background: var(--border);
}

.add-cell-divider .add-btns {
    position: relative;
    z-index: 1;
    display: flex;
    gap: 6px;
}

.add-btn {
    padding: 2px 12px;
    border: 1px solid var(--border);
    border-radius: 12px;
    background: var(--bg-secondary);
    color: var(--text-dim);
    font-size: 11px;
    font-family: var(--font-sans);
    cursor: pointer;
    transition: all var(--transition);
}

.add-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(88, 166, 255, 0.08);
}

/* The last divider is always visible */
.add-cell-divider.always-visible {
    opacity: 1;
    height: 40px;
    margin-top: 8px;
}

/* â”€â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 200;
    opacity: 0;
    pointer-events: none;
    transition: opacity 200ms ease;
}

.modal-overlay.visible {
    opacity: 1;
    pointer-events: all;
}

.modal {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    min-width: 400px;
    max-width: 560px;
    box-shadow: 0 16px 48px rgba(0,0,0,0.4);
}

.modal h2 { font-size: 16px; margin-bottom: 16px; font-weight: 600; }

.modal label {
    display: block;
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 6px;
}

.modal-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--bg-primary);
    color: var(--text-primary);
    font-size: 14px;
    font-family: var(--font-mono);
    outline: none;
    margin-bottom: 16px;
}

.modal-input:focus { border-color: var(--accent); }

.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
}

.modal-btn {
    padding: 6px 16px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: transparent;
    color: var(--text-primary);
    font-size: 13px;
    cursor: pointer;
    transition: all var(--transition);
}

.modal-btn:hover { background: var(--bg-hover); }
.modal-btn.primary { background: var(--accent); border-color: var(--accent); color: white; }
.modal-btn.primary:hover { background: var(--accent-hover); }

.modal-info {
    font-size: 12px;
    color: var(--text-dim);
    margin-bottom: 12px;
}

/* â”€â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast-container {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 300;
    display: flex;
    flex-direction: column-reverse;
    gap: 8px;
}

.toast {
    padding: 10px 16px;
    border-radius: 8px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    color: var(--text-primary);
    font-size: 13px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    animation: toastIn 200ms ease;
    max-width: 360px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.toast.success { border-color: var(--success); }
.toast.error { border-color: var(--error); }
.toast .toast-icon { font-size: 16px; }

@keyframes toastIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* â”€â”€â”€ Scrollbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

/* â”€â”€â”€ Execution Time â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.exec-time {
    display: inline-block;
    font-size: 11px;
    color: var(--text-dim);
    padding: 2px 8px;
    margin-top: 4px;
    font-family: var(--font-mono);
    opacity: 0.7;
}
.exec-time::before {
    content: 'â± ';
}

/* â”€â”€â”€ Empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-dim);
}

.empty-state .empty-icon { font-size: 48px; margin-bottom: 16px; }
.empty-state p { font-size: 14px; margin: 4px 0; }

/* â”€â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 768px) {
    .content { padding: 16px 8px; }
    .toolbar { padding: 0 8px; gap: 4px; }
    .toolbar-btn span { display: none; }
    .cell-gutter { width: 40px; }
    .cell-body { margin-left: 40px; }
}
</style>
</head>
<body>

<!-- â”€â”€â”€ Toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="toolbar" id="toolbar">
    <div class="toolbar-brand">
        <div class="logo">ScriptIt<span>Notebook</span></div>
    </div>
    <input class="toolbar-title" id="notebookTitle" value="Untitled" placeholder="Notebook titleâ€¦"
           onchange="onTitleChange()" />
    <div class="toolbar-sep"></div>

    <button class="toolbar-btn primary" onclick="runAllCells()" title="Run all cells (Ctrl+Shift+Enter)">
        <svg viewBox="0 0 16 16"><path d="M2 2.5L13 8 2 13.5z"/></svg>
        <span>Run All</span>
    </button>
    <button class="toolbar-btn" onclick="restartKernel()" title="Restart kernel (clears all state)">
        <svg viewBox="0 0 16 16"><path d="M13.5 2A6.5 6.5 0 002 8h1.5A5 5 0 0113 4.5L11 6.5h5V1.5L13.5 2zM2.5 14A6.5 6.5 0 0014 8h-1.5A5 5 0 013 11.5L5 9.5H0V14.5L2.5 14z"/></svg>
        <span>Restart</span>
    </button>
    <button class="toolbar-btn" onclick="resetKernel()" title="Reset variables only">
        <svg viewBox="0 0 16 16"><path d="M4.5 3a.5.5 0 000 1h7a.5.5 0 000-1h-7zM4 6.5a.5.5 0 01.5-.5h7a.5.5 0 010 1h-7a.5.5 0 01-.5-.5zM4.5 9a.5.5 0 000 1h7a.5.5 0 000-1h-7zM4 12.5a.5.5 0 01.5-.5h4a.5.5 0 010 1h-4a.5.5 0 01-.5-.5z"/></svg>
        <span>Reset</span>
    </button>
    <button class="toolbar-btn" onclick="clearAllOutputs()" title="Clear all cell outputs">
        <svg viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 016 6v6a.5.5 0 01-1 0V6a.5.5 0 01.5-.5zm2.5 0a.5.5 0 01.5.5v6a.5.5 0 01-1 0V6a.5.5 0 01.5-.5zm3 .5a.5.5 0 00-1 0v6a.5.5 0 001 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 01-1 1H13v9a2 2 0 01-2 2H5a2 2 0 01-2-2V4h-.5a1 1 0 010-2h3a1 1 0 011-1h3a1 1 0 011 1h3a1 1 0 011 1zM4.118 4L4 4.059V13a1 1 0 001 1h6a1 1 0 001-1V4.059L11.882 4H4.118z"/></svg>
        <span>Clear</span>
    </button>

    <div class="toolbar-sep"></div>

    <button class="toolbar-btn" onclick="saveNotebook()" title="Save (Ctrl+S)">
        <svg viewBox="0 0 16 16"><path d="M13.354 1.146l1.5 1.5A.5.5 0 0115 3v11a1 1 0 01-1 1H2a1 1 0 01-1-1V2a1 1 0 011-1h10.5a.5.5 0 01.354.146zM12 2H4v3h8V2zm0 5H4v7h8V7zM6 9h4v1H6V9z"/></svg>
        <span>Save</span>
    </button>
    <button class="toolbar-btn" onclick="showLoadModal()" title="Open notebook file">
        <svg viewBox="0 0 16 16"><path d="M1 3.5A1.5 1.5 0 012.5 2h3.379a1.5 1.5 0 011.06.44L8.061 3.5H13.5A1.5 1.5 0 0115 5v8.5a1.5 1.5 0 01-1.5 1.5h-11A1.5 1.5 0 011 13.5v-10z"/></svg>
        <span>Open</span>
    </button>
    <button class="toolbar-btn" onclick="showNewModal()" title="New notebook">
        <svg viewBox="0 0 16 16"><path d="M7.25 1h1.5v6.25H15v1.5H8.75V15h-1.5V8.75H1v-1.5h6.25V1z"/></svg>
        <span>New</span>
    </button>

    <div class="toolbar-spacer"></div>

    <div class="kernel-status">
        <div class="kernel-dot" id="kernelDot"></div>
        <span id="kernelStatus">Connectingâ€¦</span>
    </div>
</div>

<!-- â”€â”€â”€ Notebook Cells â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="content" id="cellsContainer"></div>

<!-- Hidden file input for native file browser -->
<input type="file" id="nativeFileInput" accept=".nsit,.json" style="display:none;" />
<input type="file" id="nativeFileInputAny" style="display:none;" />

<!-- â”€â”€â”€ Load Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="loadModal">
    <div class="modal" style="max-width:540px;">
        <h2>ğŸ“‚ Open Notebook</h2>
        <p class="modal-info">Browse directories, enter a path, or upload a <code>.nsit</code> file.</p>
        <label for="loadFilePath">File Path</label>
        <input class="modal-input" id="loadFilePath" placeholder="/path/to/notebook.nsit"
               onkeydown="if(event.key==='Enter'){loadNotebook();}" />
        <div id="loadFileList" style="max-height:260px;overflow-y:auto;margin:10px 0 0;"></div>
        <div class="modal-actions">
            <button class="modal-btn" onclick="hideModal('loadModal')">Cancel</button>
            <button class="modal-btn primary" onclick="loadNotebook()">Open</button>
        </div>
    </div>
</div>

<!-- â”€â”€â”€ Save-As Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="saveAsModal">
    <div class="modal" style="max-width:540px;">
        <h2>ğŸ’¾ Save Notebook As</h2>
        <p class="modal-info">Save to server path, browse your device, or download.</p>
        <div style="display:flex;gap:8px;margin-bottom:12px;">
            <button type="button" class="modal-btn primary" onclick="browseForSaveLocation()" style="flex:none;white-space:nowrap;">ğŸ“ Browseâ€¦</button>
            <button type="button" class="modal-btn" onclick="downloadNotebook()" title="Download .nsit file to your device" style="flex:none;white-space:nowrap;">â¬‡ Download</button>
            <span style="color:var(--text-dim);align-self:center;font-size:12px;">or enter path below</span>
        </div>
        <label for="saveAsPath">Server File Path</label>
        <input class="modal-input" id="saveAsPath" placeholder="/path/to/notebook.nsit"
               onkeydown="if(event.key==='Enter'){doSaveAs();}" />
        <div id="saveDirList" style="max-height:200px;overflow-y:auto;margin:10px 0 0;"></div>
        <div class="modal-actions">
            <button type="button" class="modal-btn" onclick="hideModal('saveAsModal')">Cancel</button>
            <button type="button" class="modal-btn primary" onclick="doSaveAs()">Save to Server</button>
        </div>
    </div>
</div>

<!-- â”€â”€â”€ New Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="newModal">
    <div class="modal">
        <h2>ğŸ“ New Notebook</h2>
        <p class="modal-info">Start a fresh notebook. Current unsaved work will be lost.</p>
        <label for="newTitle">Title</label>
        <input class="modal-input" id="newTitle" value="Untitled"
               onkeydown="if(event.key==='Enter'){createNewNotebook();}" />
        <div class="modal-actions">
            <button class="modal-btn" onclick="hideModal('newModal')">Cancel</button>
            <button class="modal-btn primary" onclick="createNewNotebook()">Create</button>
        </div>
    </div>
</div>

<!-- â”€â”€â”€ Toast Container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="toast-container" id="toastContainer"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let notebook = null;
let activeCellId = null;
let editingMarkdownId = null;
let savedFilePath = null;
let isRunning = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function api(path, data = null) {
    const opts = data !== null
        ? { method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify(data) }
        : { method: "GET" };
    const res = await fetch("/api" + path, opts);
    if (!res.ok) throw new Error("HTTP " + res.status);
    return res.json();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function render() {
    if (!notebook) return;
    const c = document.getElementById("cellsContainer");

    // Save scroll position and focused element info
    const scrollY = window.scrollY;
    const focusedId = document.activeElement?.id;

    c.innerHTML = "";
    document.getElementById("notebookTitle").value = notebook.metadata?.title || "Untitled";
    document.title = (notebook.metadata?.title || "Untitled") + " â€” ScriptIt Notebook";

    if (notebook.cells.length === 0) {
        c.innerHTML = '<div class="empty-state">' +
            '<div class="empty-icon">ğŸ“’</div>' +
            '<p>No cells yet.</p>' +
            '<p style="margin-top:12px;">' +
            '<button class="add-btn" onclick="addCellAt(0,\'code\')" style="padding:6px 20px;font-size:13px;">+ Code Cell</button> ' +
            '<button class="add-btn" onclick="addCellAt(0,\'markdown\')" style="padding:6px 20px;font-size:13px;">+ Markdown Cell</button>' +
            '</p></div>';
        return;
    }

    // Top add-cell divider
    c.appendChild(makeDivider(0));

    notebook.cells.forEach(function(cell, idx) {
        c.appendChild(buildCellDOM(cell, idx));
        c.appendChild(makeDivider(idx + 1));
    });

    // Make last divider always visible
    var dividers = c.querySelectorAll(".add-cell-divider");
    if (dividers.length > 0) dividers[dividers.length - 1].classList.add("always-visible");

    // Auto-resize textareas and restore focus
    requestAnimationFrame(function() {
        c.querySelectorAll(".cell-textarea").forEach(autoResize);
        if (focusedId) {
            var el = document.getElementById(focusedId);
            if (el) el.focus();
        }
        window.scrollTo(0, scrollY);
    });
}

function makeDivider(insertIndex) {
    var d = document.createElement("div");
    d.className = "add-cell-divider";
    var line = document.createElement("div");
    line.className = "divider-line";
    var btns = document.createElement("div");
    btns.className = "add-btns";

    var codeBtn = document.createElement("button");
    codeBtn.className = "add-btn";
    codeBtn.textContent = "+ Code";
    codeBtn.addEventListener("click", function() { addCellAt(insertIndex, "code"); });

    var mdBtn = document.createElement("button");
    mdBtn.className = "add-btn";
    mdBtn.textContent = "+ Markdown";
    mdBtn.addEventListener("click", function() { addCellAt(insertIndex, "markdown"); });

    btns.appendChild(codeBtn);
    btns.appendChild(mdBtn);
    d.appendChild(line);
    d.appendChild(btns);
    return d;
}

function buildCellDOM(cell, idx) {
    var div = document.createElement("div");
    div.className = "cell";
    div.id = "cell-" + cell.id;
    div.dataset.cellId = cell.id;
    div.dataset.index = idx;

    if (activeCellId === cell.id) div.classList.add("active");
    if (cell._running) div.classList.add("running");
    if (cell.outputs && cell.outputs.some(function(o) { return o.type === "stderr"; })) div.classList.add("error-state");

    div.addEventListener("click", function(e) {
        if (e.target.closest(".cell-action-btn, .cell-run-btn, .add-btn")) return;
        selectCell(cell.id);
    });

    // â”€â”€ Gutter
    var gutter = document.createElement("div");
    gutter.className = "cell-gutter";

    if (cell.type === "code") {
        var ec = cell.execution_count;
        var label = ec != null ? "[" + ec + "]" : "[ ]";
        var countSpan = document.createElement("span");
        countSpan.className = "cell-exec-count" + (ec != null ? " has-count" : "");
        countSpan.textContent = label;
        gutter.appendChild(countSpan);

        var runBtn = document.createElement("button");
        runBtn.className = "cell-run-btn";
        runBtn.title = "Run (Shift+Enter)";
        runBtn.innerHTML = '<svg viewBox="0 0 16 16"><path d="M4 2l10 6-10 6z"/></svg>';
        (function(cid) {
            runBtn.addEventListener("click", function() { runCell(cid); });
        })(cell.id);
        gutter.appendChild(runBtn);
    }

    // â”€â”€ Body
    var body = document.createElement("div");
    body.className = "cell-body";

    if (cell.type === "code") {
        body.appendChild(buildEditor(cell));
        body.appendChild(buildOutput(cell));
    } else {
        // Markdown
        if (editingMarkdownId === cell.id || !cell.source.trim()) {
            body.appendChild(buildEditor(cell));
        } else {
            var mdWrap = document.createElement("div");
            mdWrap.style.position = "relative";

            var rendered = document.createElement("div");
            rendered.className = "markdown-rendered";
            rendered.innerHTML = renderMarkdown(cell.source);
            (function(cid) {
                rendered.addEventListener("dblclick", function() {
                    editingMarkdownId = cid;
                    render();
                    focusEditor(cid);
                });
            })(cell.id);

            // Edit button for markdown cells
            var editBtn = document.createElement("button");
            editBtn.className = "markdown-edit-btn";
            editBtn.title = "Edit markdown (or double-click)";
            editBtn.textContent = "âœï¸";
            (function(cid) {
                editBtn.addEventListener("click", function() {
                    editingMarkdownId = cid;
                    render();
                    focusEditor(cid);
                });
            })(cell.id);

            mdWrap.appendChild(editBtn);
            mdWrap.appendChild(rendered);
            body.appendChild(mdWrap);
        }
    }

    // â”€â”€ Actions
    var actions = document.createElement("div");
    actions.className = "cell-actions";

    // Clear output
    if (cell.type === "code" && cell.outputs && cell.outputs.length > 0) {
        (function(c) {
            actions.appendChild(makeActionBtn("âŠ˜", "Clear output", function() {
                c.outputs = [];
                c.execution_count = null;
                render();
            }));
        })(cell);
    }

    // Type toggle
    (function(cid, ctype) {
        actions.appendChild(makeActionBtn(
            ctype === "code" ? "Mâ†“" : "{ }",
            ctype === "code" ? "Convert to Markdown" : "Convert to Code",
            function() { toggleCellType(cid); }
        ));
    })(cell.id, cell.type);

    // Move up
    (function(i) {
        actions.appendChild(makeActionBtn("â†‘", "Move up", function() { moveCellLocal(i, -1); }));
    })(idx);

    // Move down
    (function(i) {
        actions.appendChild(makeActionBtn("â†“", "Move down", function() { moveCellLocal(i, 1); }));
    })(idx);

    // Delete
    (function(cid) {
        var btn = makeActionBtn("âœ•", "Delete cell", function() { deleteCell(cid); });
        btn.classList.add("delete");
        actions.appendChild(btn);
    })(cell.id);

    div.appendChild(gutter);
    div.appendChild(body);
    div.appendChild(actions);
    return div;
}

function makeActionBtn(text, title, onclick) {
    var btn = document.createElement("button");
    btn.className = "cell-action-btn";
    btn.title = title;
    btn.textContent = text;
    btn.addEventListener("click", onclick);
    return btn;
}

function buildEditor(cell) {
    var wrap = document.createElement("div");
    wrap.className = "cell-editor";
    var ta = document.createElement("textarea");
    ta.className = "cell-textarea";
    ta.id = "editor-" + cell.id;
    ta.spellcheck = false;
    ta.placeholder = cell.type === "code" ? "# Enter ScriptIt codeâ€¦" : "# Markdown textâ€¦";
    ta.value = cell.source;

    (function(c, textarea) {
        textarea.addEventListener("input", function() {
            autoResize(textarea);
            c.source = textarea.value;
        });
        textarea.addEventListener("keydown", function(e) { handleEditorKeydown(e, c); });
        textarea.addEventListener("focus", function() { selectCell(c.id); });
    })(cell, ta);

    wrap.appendChild(ta);
    return wrap;
}

function buildOutput(cell) {
    var div = document.createElement("div");
    div.className = "cell-output";
    if ((!cell.outputs || cell.outputs.length === 0) && !cell._execTime) return div;
    for (var i = 0; i < (cell.outputs || []).length; i++) {
        var out = cell.outputs[i];
        var pre = document.createElement("pre");
        pre.className = out.type === "stderr" ? "output-stderr"
                      : out.type === "result" ? "output-result"
                      : "output-stdout";
        pre.textContent = out.text;
        div.appendChild(pre);
    }
    // Show execution time
    if (cell._execTime) {
        var timeSpan = document.createElement("span");
        timeSpan.className = "exec-time";
        timeSpan.textContent = cell._execTime + "s";
        div.appendChild(timeSpan);
    }
    return div;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CELL OPERATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function selectCell(id) {
    if (activeCellId === id) return;
    if (editingMarkdownId && editingMarkdownId !== id) {
        editingMarkdownId = null;
    }
    activeCellId = id;
    document.querySelectorAll(".cell").forEach(function(el) {
        el.classList.toggle("active", el.dataset.cellId === id);
    });
}

function focusEditor(cellId) {
    requestAnimationFrame(function() {
        var ed = document.getElementById("editor-" + cellId);
        if (ed) { autoResize(ed); ed.focus(); }
    });
}

async function runCell(cellId) {
    var cell = notebook.cells.find(function(c) { return c.id === cellId; });
    if (!cell || cell.type !== "code") return;

    syncCellSource(cellId);
    if (!cell.source.trim()) return;

    cell._running = true;
    // Clear old outputs immediately when re-running the same cell
    cell.outputs = [];
    cell.execution_count = null;
    delete cell._execTime;
    setKernelStatus("busy");
    render();

    var startTime = performance.now();
    try {
        var result = await api("/execute", { cell_id: cellId, code: cell.source });
        cell.execution_count = result.execution_count;
        cell.outputs = [];
        if (result.stdout) cell.outputs.push({ type: "stdout", text: result.stdout });
        if (result.stderr) cell.outputs.push({ type: "stderr", text: result.stderr });
        if (result.result) cell.outputs.push({ type: "result", text: result.result });
    } catch (e) {
        cell.outputs = [{ type: "stderr", text: "Connection error: " + e.message }];
    }

    cell._execTime = ((performance.now() - startTime) / 1000).toFixed(3);
    cell._running = false;
    setKernelStatus("idle");

    // Move focus to next cell
    var idx = notebook.cells.indexOf(cell);
    if (idx < notebook.cells.length - 1) {
        activeCellId = notebook.cells[idx + 1].id;
    }
    render();
    if (idx < notebook.cells.length - 1) {
        focusEditor(notebook.cells[idx + 1].id);
    }
}

async function runAllCells() {
    if (isRunning) return;
    isRunning = true;
    setKernelStatus("busy");
    syncAllSources();

    var hasError = false;
    for (var i = 0; i < notebook.cells.length; i++) {
        var cell = notebook.cells[i];
        if (cell.type !== "code" || !cell.source.trim()) continue;

        cell._running = true;
        activeCellId = cell.id;
        render();

        var cellStart = performance.now();
        try {
            var result = await api("/execute", { cell_id: cell.id, code: cell.source });
            cell.execution_count = result.execution_count;
            cell.outputs = [];
            if (result.stdout) cell.outputs.push({ type: "stdout", text: result.stdout });
            if (result.stderr) cell.outputs.push({ type: "stderr", text: result.stderr });
            if (result.result) cell.outputs.push({ type: "result", text: result.result });
            if (result.status === "error") hasError = true;
        } catch (e) {
            cell.outputs = [{ type: "stderr", text: "Error: " + e.message }];
            hasError = true;
        }

        cell._execTime = ((performance.now() - cellStart) / 1000).toFixed(3);
        cell._running = false;
        render();
    }

    isRunning = false;
    setKernelStatus("idle");
    toast(hasError ? "Run All completed with errors" : "All cells executed âœ“", hasError ? "error" : "success");
}

function addCellAt(index, type) {
    var afterId = index > 0 ? notebook.cells[index - 1].id : null;

    var newCell = {
        id: generateId(),
        type: type,
        source: "",
        outputs: [],
        execution_count: null,
        metadata: {}
    };

    notebook.cells.splice(index, 0, newCell);
    activeCellId = newCell.id;
    if (type === "markdown") editingMarkdownId = newCell.id;

    // Tell server (fire and forget)
    api("/cell/add", { type: type, after_id: afterId }).catch(function() {});

    render();
    focusEditor(newCell.id);
}

function deleteCell(cellId) {
    if (notebook.cells.length <= 1) {
        toast("Can't delete the last cell", "error");
        return;
    }

    var idx = notebook.cells.findIndex(function(c) { return c.id === cellId; });
    notebook.cells.splice(idx, 1);

    if (activeCellId === cellId) {
        activeCellId = notebook.cells[Math.max(0, idx - 1)].id;
    }
    if (editingMarkdownId === cellId) editingMarkdownId = null;

    api("/cell/delete", { cell_id: cellId }).catch(function() {});
    render();
}

function moveCellLocal(idx, direction) {
    var newIdx = idx + direction;
    if (newIdx < 0 || newIdx >= notebook.cells.length) return;

    var cellId = notebook.cells[idx].id;
    var temp = notebook.cells[idx];
    notebook.cells[idx] = notebook.cells[newIdx];
    notebook.cells[newIdx] = temp;

    api("/cell/move", {
        cell_id: cellId,
        direction: direction < 0 ? "up" : "down"
    }).catch(function() {});

    render();
}

function toggleCellType(cellId) {
    var cell = notebook.cells.find(function(c) { return c.id === cellId; });
    if (!cell) return;

    syncCellSource(cellId);
    cell.type = cell.type === "code" ? "markdown" : "code";
    cell.outputs = [];
    cell.execution_count = null;

    if (cell.type === "markdown") {
        editingMarkdownId = cellId;
    } else {
        editingMarkdownId = null;
    }

    api("/cell/type", { cell_id: cellId, type: cell.type }).catch(function() {});
    render();
    focusEditor(cellId);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NOTEBOOK I/O
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function saveNotebook() {
    if (!notebook) return;
    syncAllSources();
    notebook.metadata.title = document.getElementById("notebookTitle").value.trim() || "Untitled";

    // If no saved file path, prompt for one
    if (!savedFilePath) {
        showSaveAsModal();
        return;
    }

    try {
        var result = await api("/notebook/save", {
            cells: notebook.cells,
            metadata: notebook.metadata,
            filepath: savedFilePath
        });
        if (result.status === "saved") {
            savedFilePath = result.filepath;
            toast("Saved: " + result.filepath, "success");
        } else {
            toast("Save failed: " + (result.message || ""), "error");
        }
    } catch (e) {
        toast("Save error: " + e.message, "error");
    }
}

function showSaveAsModal() {
    document.getElementById("saveAsModal").classList.add("visible");
    var input = document.getElementById("saveAsPath");
    var title = (notebook && notebook.metadata && notebook.metadata.title) || "Untitled";
    input.value = savedFilePath || (title + ".nsit");
    // Clear any previous browse results
    var listDiv = document.getElementById("saveDirList");
    if (listDiv) listDiv.innerHTML = "";
    setTimeout(function() { input.focus(); input.select(); }, 100);
    // Auto-load directory browser (like load modal does)
    showServerBrowser("save");
}

async function doSaveAs() {
    var filepath = document.getElementById("saveAsPath").value.trim();
    if (!filepath) {
        toast("Please enter a file path", "error");
        return;
    }
    if (!filepath.endsWith(".nsit")) filepath += ".nsit";
    hideModal("saveAsModal");

    syncAllSources();
    notebook.metadata.title = document.getElementById("notebookTitle").value.trim() || "Untitled";

    try {
        var result = await api("/notebook/save", {
            cells: notebook.cells,
            metadata: notebook.metadata,
            filepath: filepath
        });
        if (result.status === "saved") {
            savedFilePath = result.filepath;
            toast("Saved: " + result.filepath, "success");
        } else {
            toast("Save failed: " + (result.message || ""), "error");
        }
    } catch (e) {
        toast("Save error: " + e.message, "error");
    }
}

function browseForFile() {
    // Use server-side directory browser for loading
    showServerBrowser("load");
}

async function showServerBrowser(mode) {
    // mode: "load" or "save"
    var targetModal = mode === "load" ? "loadModal" : "saveAsModal";
    var targetInput = mode === "load" ? "loadFilePath" : "saveAsPath";
    var listDiv = mode === "load" ? document.getElementById("loadFileList") : document.getElementById("saveDirList");

    async function browseTo(dirPath) {
        // Only show "Loadingâ€¦" if div is empty (don't flash away existing results)
        if (!listDiv.hasChildNodes() || listDiv.children.length === 0) {
            listDiv.innerHTML = '<span style="color:#888;font-size:12px;">Loadingâ€¦</span>';
        }
        try {
            var result = await api("/browse?path=" + encodeURIComponent(dirPath));
            listDiv.innerHTML = "";

            // Show current path
            var pathLabel = document.createElement("div");
            pathLabel.style.cssText = "color:#58a6ff;font-size:12px;margin-bottom:8px;padding:4px 8px;background:rgba(88,166,255,0.08);border-radius:4px;font-family:var(--font-mono);word-break:break-all;";
            pathLabel.textContent = "ğŸ“ " + result.current;
            listDiv.appendChild(pathLabel);

            if (result.error) {
                var errDiv = document.createElement("div");
                errDiv.style.cssText = "color:#f85149;font-size:12px;padding:4px 8px;";
                errDiv.textContent = result.error;
                listDiv.appendChild(errDiv);
            }

            // If in save mode, show "Save Here" button
            if (mode === "save") {
                var saveHereBtn = document.createElement("button");
                saveHereBtn.className = "add-btn";
                saveHereBtn.style.cssText = "margin:4px 0 8px;padding:4px 16px;font-size:12px;";
                saveHereBtn.textContent = "ğŸ’¾ Save in this folder";
                saveHereBtn.addEventListener("click", function() {
                    var title = (notebook && notebook.metadata && notebook.metadata.title) || "Untitled";
                    document.getElementById(targetInput).value = result.current + "/" + title + ".nsit";
                });
                listDiv.appendChild(saveHereBtn);
            }

            // Also add upload from device option for load mode
            if (mode === "load") {
                var uploadBtn = document.createElement("button");
                uploadBtn.className = "add-btn";
                uploadBtn.style.cssText = "margin:0 0 8px;padding:4px 16px;font-size:12px;";
                uploadBtn.textContent = "ğŸ’» Upload from this device insteadâ€¦";
                uploadBtn.addEventListener("click", function() {
                    var fileInput = document.getElementById("nativeFileInput");
                    fileInput.value = "";
                    fileInput.onchange = function(e) {
                        var file = e.target.files[0];
                        if (!file) return;
                        var reader = new FileReader();
                        reader.onload = function(ev) {
                            try {
                                var data = JSON.parse(ev.target.result);
                                if (!data.cells || !data.metadata) {
                                    toast("Invalid notebook file â€” missing cells or metadata", "error");
                                    return;
                                }
                                notebook = data;
                                savedFilePath = null;
                                activeCellId = (notebook.cells && notebook.cells[0]) ? notebook.cells[0].id : null;
                                editingMarkdownId = null;
                                if (notebook.metadata && notebook.metadata.title) {
                                    document.getElementById("notebookTitle").value = notebook.metadata.title;
                                    document.title = notebook.metadata.title + " â€” ScriptIt Notebook";
                                }
                                hideModal("loadModal");
                                render();
                                toast("Loaded from device: " + file.name, "success");
                            } catch (err) {
                                toast("Failed to parse file: " + err.message, "error");
                            }
                        };
                        reader.readAsText(file);
                    };
                    fileInput.click();
                });
                listDiv.appendChild(uploadBtn);
            }

            for (var i = 0; i < (result.entries || []).length; i++) {
                (function(entry) {
                    var item = document.createElement("div");
                    item.style.cssText = "padding:5px 10px;cursor:pointer;border-radius:4px;font-size:13px;color:#ccc;display:flex;align-items:center;gap:6px;";
                    var icon = entry.type === "dir" ? "ğŸ“" : "ğŸ“„";
                    item.innerHTML = '<span style="opacity:0.7;">' + icon + '</span><span>' + escapeHtml(entry.name) + '</span>';
                    item.addEventListener("mouseenter", function() { item.style.background = "rgba(255,255,255,0.06)"; });
                    item.addEventListener("mouseleave", function() { item.style.background = "none"; });
                    item.addEventListener("click", function() {
                        if (entry.type === "dir") {
                            browseTo(entry.path);
                        } else {
                            document.getElementById(targetInput).value = entry.path;
                            if (mode === "load") {
                                loadNotebook();
                            }
                        }
                    });
                    listDiv.appendChild(item);
                })(result.entries[i]);
            }
        } catch (e) {
            listDiv.innerHTML = '<span style="color:#666;font-size:12px;">Could not browse: ' + escapeHtml(e.message) + '</span>';
        }
    }

    // Start browsing from NOTEBOOK_DIR
    browseTo("");
}

function browseForSaveLocation() {
    // Always refresh the directory browser when Browse is clicked
    showServerBrowser("save");
    var listDiv = document.getElementById("saveDirList");
    if (listDiv) {
        setTimeout(function() { listDiv.scrollIntoView({ behavior: "smooth", block: "nearest" }); }, 200);
    }
}

function downloadNotebook() {
    if (!notebook) { toast("No notebook to download", "error"); return; }
    syncAllSources();
    notebook.metadata.title = document.getElementById("notebookTitle").value.trim() || "Untitled";
    notebook.metadata.modified = new Date().toISOString();

    var json = JSON.stringify(notebook, null, 2);
    var blob = new Blob([json], { type: "application/json" });
    var url = URL.createObjectURL(blob);
    var a = document.createElement("a");
    a.href = url;
    a.download = (notebook.metadata.title || "Untitled") + ".nsit";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    hideModal("saveAsModal");
    toast("Downloaded: " + a.download, "success");
}

async function showLoadModal() {
    document.getElementById("loadModal").classList.add("visible");
    var input = document.getElementById("loadFilePath");
    input.value = "";
    setTimeout(function() { input.focus(); }, 100);

    // Use server-side browser to show directory listing
    showServerBrowser("load");
}

function showNewModal() {
    document.getElementById("newModal").classList.add("visible");
    var input = document.getElementById("newTitle");
    input.value = "Untitled";
    setTimeout(function() { input.focus(); input.select(); }, 100);
}

function hideModal(id) {
    document.getElementById(id).classList.remove("visible");
}

async function loadNotebook() {
    var filepath = document.getElementById("loadFilePath").value.trim();
    if (!filepath) {
        toast("Please enter a file path", "error");
        return;
    }
    hideModal("loadModal");

    try {
        var result = await api("/notebook/load", { filepath: filepath });
        if (result.status === "error") {
            toast("Load failed: " + result.message, "error");
            return;
        }
        notebook = result;
        savedFilePath = filepath;
        activeCellId = (notebook.cells && notebook.cells[0]) ? notebook.cells[0].id : null;
        editingMarkdownId = null;
        render();
        toast("Loaded: " + filepath, "success");
    } catch (e) {
        toast("Load error: " + e.message, "error");
    }
}

async function createNewNotebook() {
    var title = document.getElementById("newTitle").value.trim() || "Untitled";
    hideModal("newModal");

    try {
        notebook = await api("/notebook/new", { title: title });
        savedFilePath = null;
        activeCellId = (notebook.cells && notebook.cells[0]) ? notebook.cells[0].id : null;
        editingMarkdownId = null;
        render();
        toast("New notebook: " + title, "success");
    } catch (e) {
        toast("Error: " + e.message, "error");
    }
}

function onTitleChange() {
    if (notebook) {
        notebook.metadata.title = document.getElementById("notebookTitle").value.trim() || "Untitled";
        document.title = notebook.metadata.title + " â€” ScriptIt Notebook";
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KERNEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function restartKernel() {
    setKernelStatus("busy");
    try {
        var result = await api("/kernel/restart", {});
        // Clear all cell outputs on restart
        if (notebook && notebook.cells) {
            for (var i = 0; i < notebook.cells.length; i++) {
                notebook.cells[i].outputs = [];
                notebook.cells[i].execution_count = null;
                delete notebook.cells[i]._execTime;
            }
        }
        setKernelStatus("idle");
        render();
        toast("Kernel restarted â€” all state and outputs cleared", "success");
    } catch (e) {
        // If restart failed, try to recover by checking status
        try {
            var s = await api("/kernel/status");
            if (s.alive) {
                setKernelStatus("idle");
                toast("Restart had issues but kernel is alive", "info");
            } else {
                setKernelStatus("dead");
                toast("Restart failed â€” kernel is dead. Try restarting the server.", "error");
            }
        } catch (e2) {
            setKernelStatus("dead");
            toast("Restart failed: " + e.message, "error");
        }
        render();
    }
}

function clearAllOutputs() {
    if (!notebook || !notebook.cells) return;
    var cleared = 0;
    for (var i = 0; i < notebook.cells.length; i++) {
        if (notebook.cells[i].outputs && notebook.cells[i].outputs.length > 0) cleared++;
        notebook.cells[i].outputs = [];
        notebook.cells[i].execution_count = null;
        delete notebook.cells[i]._execTime;
    }
    render();
    toast("Cleared outputs from " + cleared + " cell" + (cleared !== 1 ? "s" : ""), "success");
}

async function resetKernel() {
    setKernelStatus("busy");
    try {
        var result = await api("/kernel/reset", {});
        if (result.status === "reset_ok") {
            // Clear all cell outputs and execution state
            if (notebook && notebook.cells) {
                for (var i = 0; i < notebook.cells.length; i++) {
                    notebook.cells[i].outputs = [];
                    notebook.cells[i].execution_count = null;
                    delete notebook.cells[i]._execTime;
                }
            }
            setKernelStatus("idle");
            render();
            toast("Kernel reset â€” all variables and outputs cleared", "success");
        } else {
            setKernelStatus("idle");
            toast("Reset response: " + (result.status || "unknown"), "info");
        }
    } catch (e) {
        // If reset fails, the kernel might be dead â€” try to restart
        try {
            await api("/kernel/restart", {});
            if (notebook && notebook.cells) {
                for (var i = 0; i < notebook.cells.length; i++) {
                    notebook.cells[i].outputs = [];
                    notebook.cells[i].execution_count = null;
                    delete notebook.cells[i]._execTime;
                }
            }
            setKernelStatus("idle");
            render();
            toast("Reset failed â€” kernel restarted instead", "info");
        } catch (e2) {
            setKernelStatus("dead");
            toast("Reset failed: " + e.message, "error");
        }
    }
}

function setKernelStatus(state) {
    var dot = document.getElementById("kernelDot");
    var text = document.getElementById("kernelStatus");
    dot.className = "kernel-dot";
    if (state === "idle")  { text.textContent = "Idle"; }
    else if (state === "busy")  { dot.classList.add("busy"); text.textContent = "Runningâ€¦"; }
    else if (state === "dead")  { dot.classList.add("dead"); text.textContent = "Disconnected"; }
}

async function checkKernel() {
    try {
        var s = await api("/kernel/status");
        setKernelStatus(s.alive ? "idle" : "dead");
    } catch (e) {
        setKernelStatus("dead");
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EDITOR HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function handleEditorKeydown(e, cell) {
    var cellId = cell.id;

    // Shift+Enter â†’ run cell (code) or finish editing (markdown)
    if (e.key === "Enter" && e.shiftKey) {
        e.preventDefault();
        if (cell.type === "code") {
            runCell(cellId);
        } else {
            editingMarkdownId = null;
            cell.source = e.target.value;
            var idx = notebook.cells.indexOf(cell);
            if (idx < notebook.cells.length - 1) {
                activeCellId = notebook.cells[idx + 1].id;
            }
            render();
        }
        return;
    }

    // Ctrl+Enter â†’ run cell and stay
    if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        if (cell.type === "code") {
            syncCellSource(cellId);
            if (!cell.source.trim()) return;
            cell._running = true;
            setKernelStatus("busy");
            var ctrlStart = performance.now();
            render();
            api("/execute", { cell_id: cellId, code: cell.source })
                .then(function(result) {
                    cell.execution_count = result.execution_count;
                    cell.outputs = [];
                    if (result.stdout) cell.outputs.push({ type: "stdout", text: result.stdout });
                    if (result.stderr) cell.outputs.push({ type: "stderr", text: result.stderr });
                    if (result.result) cell.outputs.push({ type: "result", text: result.result });
                    cell._execTime = ((performance.now() - ctrlStart) / 1000).toFixed(3);
                })
                .catch(function(err) {
                    cell.outputs = [{ type: "stderr", text: "Error: " + err.message }];
                })
                .finally(function() {
                    cell._running = false;
                    setKernelStatus("idle");
                    render();
                    focusEditor(cellId);
                });
        }
        return;
    }

    // Tab â†’ insert 4 spaces
    if (e.key === "Tab" && !e.shiftKey) {
        e.preventDefault();
        var ta = e.target;
        var start = ta.selectionStart;
        var end = ta.selectionEnd;
        ta.value = ta.value.substring(0, start) + "    " + ta.value.substring(end);
        ta.selectionStart = ta.selectionEnd = start + 4;
        autoResize(ta);
        cell.source = ta.value;
        return;
    }

    // Shift+Tab â†’ remove up to 4 leading spaces
    if (e.key === "Tab" && e.shiftKey) {
        e.preventDefault();
        var ta2 = e.target;
        var start2 = ta2.selectionStart;
        var lineStart = ta2.value.lastIndexOf("\n", start2 - 1) + 1;
        var linePrefix = ta2.value.substring(lineStart, start2);
        var spaces = linePrefix.match(/^ {1,4}/);
        if (spaces) {
            ta2.value = ta2.value.substring(0, lineStart) + ta2.value.substring(lineStart + spaces[0].length);
            ta2.selectionStart = ta2.selectionEnd = start2 - spaces[0].length;
        }
        autoResize(ta2);
        cell.source = ta2.value;
        return;
    }

    // Escape â†’ stop editing markdown
    if (e.key === "Escape") {
        if (cell.type === "markdown" && editingMarkdownId === cellId) {
            editingMarkdownId = null;
            cell.source = e.target.value;
            render();
        }
    }
}

function autoResize(ta) {
    ta.style.height = "auto";
    ta.style.height = Math.max(42, ta.scrollHeight) + "px";
}

function syncCellSource(cellId) {
    var ta = document.getElementById("editor-" + cellId);
    var cell = notebook.cells.find(function(c) { return c.id === cellId; });
    if (ta && cell) cell.source = ta.value;
}

function syncAllSources() {
    for (var i = 0; i < notebook.cells.length; i++) {
        syncCellSource(notebook.cells[i].id);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MARKDOWN RENDERER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderMarkdown(text) {
    var codeBlocks = [];
    text = text.replace(/```(\w*)\n([\s\S]*?)```/g, function(_, lang, code) {
        codeBlocks.push('<pre><code>' + escapeHtml(code.trim()) + '</code></pre>');
        return '%%CODEBLOCK' + (codeBlocks.length - 1) + '%%';
    });

    var lines = text.split("\n");
    var html = [];
    var inList = false;

    for (var i = 0; i < lines.length; i++) {
        var line = lines[i];

        if (line.indexOf("%%CODEBLOCK") !== -1) {
            if (inList) { html.push("</ul>"); inList = false; }
            var m = line.match(/%%CODEBLOCK(\d+)%%/);
            html.push(codeBlocks[parseInt(m ? m[1] : "0")] || "");
            continue;
        }

        if (line.indexOf("### ") === 0) { if (inList) { html.push("</ul>"); inList = false; } html.push("<h3>" + inlineMd(line.slice(4)) + "</h3>"); continue; }
        if (line.indexOf("## ") === 0)  { if (inList) { html.push("</ul>"); inList = false; } html.push("<h2>" + inlineMd(line.slice(3)) + "</h2>"); continue; }
        if (line.indexOf("# ") === 0)   { if (inList) { html.push("</ul>"); inList = false; } html.push("<h1>" + inlineMd(line.slice(2)) + "</h1>"); continue; }

        if (/^---+$/.test(line)) { if (inList) { html.push("</ul>"); inList = false; } html.push("<hr>"); continue; }
        if (line.indexOf("> ") === 0) { if (inList) { html.push("</ul>"); inList = false; } html.push("<blockquote>" + inlineMd(line.slice(2)) + "</blockquote>"); continue; }

        if (/^[-*] /.test(line)) {
            if (!inList) { html.push("<ul>"); inList = true; }
            html.push("<li>" + inlineMd(line.slice(2)) + "</li>");
            continue;
        }

        if (inList) { html.push("</ul>"); inList = false; }
        if (line.trim() === "") { html.push(""); continue; }
        html.push("<p>" + inlineMd(line) + "</p>");
    }

    if (inList) html.push("</ul>");
    return html.join("\n");
}

function inlineMd(text) {
    return text
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function escapeHtml(text) {
    var d = document.createElement("div");
    d.textContent = text;
    return d.innerHTML;
}

function generateId() {
    return "c" + Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
}

function toast(message, type) {
    type = type || "info";
    var container = document.getElementById("toastContainer");
    var t = document.createElement("div");
    t.className = "toast " + type;
    var icon = type === "success" ? "âœ…" : type === "error" ? "âŒ" : "â„¹ï¸";
    t.innerHTML = '<span class="toast-icon">' + icon + '</span>' + escapeHtml(message);
    container.appendChild(t);
    setTimeout(function() {
        t.style.opacity = "0";
        t.style.transform = "translateY(10px)";
        t.style.transition = "all 200ms ease";
        setTimeout(function() { t.remove(); }, 200);
    }, 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KEYBOARD SHORTCUTS (global)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.addEventListener("keydown", function(e) {
    // Ctrl+S â†’ Save
    if ((e.ctrlKey || e.metaKey) && e.key === "s") {
        e.preventDefault();
        saveNotebook();
    }

    // Ctrl+Shift+Enter â†’ Run All
    if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === "Enter") {
        e.preventDefault();
        runAllCells();
    }

    // Escape â†’ close modals
    if (e.key === "Escape") {
        hideModal("loadModal");
        hideModal("newModal");
        hideModal("saveAsModal");
    }

    // Jupyter-style shortcuts when NOT focused in a textarea/input
    if (e.target.tagName === "TEXTAREA" || e.target.tagName === "INPUT") return;
    if (!notebook || !notebook.cells.length) return;

    var idx = notebook.cells.findIndex(function(c) { return c.id === activeCellId; });

    // Arrow navigation
    if (e.key === "ArrowUp" && idx > 0) {
        e.preventDefault();
        activeCellId = notebook.cells[idx - 1].id;
        render();
        document.getElementById("cell-" + activeCellId)?.scrollIntoView({ block: "nearest" });
    }
    if (e.key === "ArrowDown" && idx < notebook.cells.length - 1) {
        e.preventDefault();
        activeCellId = notebook.cells[idx + 1].id;
        render();
        document.getElementById("cell-" + activeCellId)?.scrollIntoView({ block: "nearest" });
    }

    // b â†’ add code cell below
    if (e.key === "b" && idx >= 0) {
        e.preventDefault();
        addCellAt(idx + 1, "code");
    }

    // a â†’ add code cell above
    if (e.key === "a" && idx >= 0) {
        e.preventDefault();
        addCellAt(idx, "code");
    }

    // dd â†’ delete cell
    if (e.key === "d") {
        if (window._lastDTime && Date.now() - window._lastDTime < 400) {
            e.preventDefault();
            if (activeCellId) deleteCell(activeCellId);
            window._lastDTime = 0;
        } else {
            window._lastDTime = Date.now();
        }
    }

    // m â†’ to markdown
    if (e.key === "m" && idx >= 0) {
        var c = notebook.cells[idx];
        if (c.type === "code") toggleCellType(c.id);
    }

    // y â†’ to code
    if (e.key === "y" && idx >= 0) {
        var c2 = notebook.cells[idx];
        if (c2.type === "markdown") toggleCellType(c2.id);
    }

    // Enter â†’ enter edit mode
    if (e.key === "Enter" && idx >= 0) {
        e.preventDefault();
        var c3 = notebook.cells[idx];
        if (c3.type === "markdown") {
            editingMarkdownId = c3.id;
            render();
        }
        focusEditor(c3.id);
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function init() {
    try {
        notebook = await api("/notebook");
        activeCellId = (notebook.cells && notebook.cells[0]) ? notebook.cells[0].id : null;
        render();
        checkKernel();
        toast("Notebook loaded", "success");
    } catch (e) {
        toast("Failed to connect to server", "error");
        setKernelStatus("dead");
    }

    setInterval(checkKernel, 15000);
}

init();
</script>
</body>
</html>
